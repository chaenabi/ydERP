<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="stocks">

	<!-- 판매 내역 전체 조회 -->
	<select id="getStockInOutList" resultType="stockin">
		<![CDATA[
		SELECT *
		FROM   stock_in_out_vo
		]]>
		<where>
			<if test="itemCode != null and itemCode != '' ">
				AND item_code like '%'||#{itemCode}||'%'
			</if>
			<if test="itemName != null and itemName != '' ">
				AND item_name like '%'||#{itemName}||'%'
			</if>
			<if test="poSoNumber != null and poSoNumber != '' ">
				AND dealer_code like '%'||#{poSoNumber}||'%'
			</if>
			<if test="fromDate != null and fromDate != '' ">
				<![CDATA[
				AND txn_date >= TO_DATE(#{fromDate},'rrrr-mm-dd')
				]]>
			</if>
			<if test="toDate != null and toDate != '' ">
				<![CDATA[
				AND txn_date <= TO_DATE(#{toDate},'rrrr-mm-dd')
				]]>
			</if>
		</where>
		ORDER BY stock_id
	</select>

	<select id="getItemInOutList" resultType="stockin">
		<![CDATA[
		SELECT *
		FROM stock_in_out_vo
		]]>
		<where>
			<if test="itemCode!=null">
				AND item_code = #{itemCode}
			</if>
		</where>
		ORDER BY txn_date
	</select>

	<select id="getStockOnhandList" resultType="com.yedam.erp.stocks.StockOnhandViewVO">
		<![CDATA[
		SELECT v.*, common.get_vendor_name(v.vendor_code) vendor_name
		FROM   stock_onhands_vo v
		]]>
		<where>
			<if test="itemCode != null">
				AND item_code like '%'||#{itemCode}||'%'
			</if>
			<if test="itemName != null">
				AND item_name like '%'||#{itemName}||'%'
			</if>
			<if test="vendorCode != null">
				AND vendor_code like #{vendorCode}||'%'
			</if>
		</where>
		ORDER BY item_code
	</select>

	<select id="getPurchaseRequestList" resultType="purchaserequest">
		<![CDATA[
		SELECT common.get_vendor_name(v.vendor_code) vendor_name, v.*
		FROM   purchase_request_vo v
		ORDER BY vendor_code, item_code
		]]>
	</select>

	<insert id="insertPurchaseProc" parameterType="purchaserequest"
		statementType="CALLABLE">
		<![CDATA[
		{call common.in_txn(#{pTxnNo})}
		]]>
	</insert>

	<insert id="insertPurchaseRequest" parameterType="purchaserequest"
		statementType="CALLABLE">
		<![CDATA[
		{call common.create_purchase_info(#{pMsg ,mode=OUT,jdbcType=VARCHAR,javaType=String})}
		]]>
	</insert>

	<select id="getPurchaseRequestTempListData" resultType="com.yedam.erp.stocks.PurchaseDetailTempVO">
		<![CDATA[
		SELECT *
		FROM   purchase_detail_temp_vo v
		ORDER BY vendor_code, item_code
		]]>
	</select>

	<insert id="insertPurchaseRequestTemp" parameterType="com.yedam.erp.stocks.PurchaseDetailTempVO">
		<![CDATA[
		INSERT INTO purchase_detail_temp
		VALUES  (TO_CHAR(purchase_detail_seq.nextval)
			    ,'TEMP Master'
			    ,#{vendorCode}
			    ,#{itemCode}
			    ,#{reqQty}
			    ,#{supplyPrice}
			    ,#{itemTax}
			    )
		]]>
	</insert>

	<select id="getlookUpValueList" resultType="map">
		<![CDATA[
		SELECT lv.lookup_code
		      ,lv.lookup_values
		FROM   lookups lk
		JOIN   lookup_values lv
		ON     lk.lookup = lv.lookup
		WHERE  lk.lookup = 'SUBINVENTORY'
		]]>
	</select>

	<select id="getVendorList" resultType="map">
		<![CDATA[
		SELECT vendor_code
		      ,vendor_name
		FROM   vendors
		ORDER  BY vendor_name
		]]>
	</select>

	<select id="getReceiptHeaders" resultType="com.yedam.erp.stocks.PurchaseHeadersVO">
		<![CDATA[
		SELECT p.*, common.get_vendor_name(p.vendor_code) vendor_name
		FROM   purchases p
		WHERE NVL(in_flag,'N') = 'N'
		ORDER BY purchase_code DESC
		]]>
	</select>

	<select id="getReceiptLines" resultType="com.yedam.erp.stocks.PurchaseDetailsVO">
		<![CDATA[
		SELECT p.*, common.get_item_name(p.purchase_item) item_name
		FROM   purchase_details p
		]]>
		<where>
			<if test="purchaseCode != null">
				AND purchase_code = #{purchaseCode}
			</if>
		</where>
		ORDER BY purchase_detail_code
	</select>

	<select id="getMostSoldItem" resultType="map">
		<![CDATA[
		SELECT itm.item_name
		      ,quantity
		FROM   (SELECT st.item_code item
		              ,TO_CHAR(SUM(st.in_qty)) quantity
		        FROM   stocks_in_out st
		        GROUP  BY st.item_code
		        ORDER  BY quantity DESC) a
		      ,items itm
		WHERE  a.item = itm.item_code
		AND    ROWNUM <= 5		
		]]>
	</select>

	<select id="getLookupsData" parameterType="string" resultType="map">
		<![CDATA[
		SELECT lk.lookup lookups
		      ,lk.lookup_description
		      ,lv.lookup
		      ,lv.lookup_code
		      ,lv.lookup_values
		      ,lv.descriptions
		      ,lv.flag
		      ,lv.dff
		      ,lv.reflag
		FROM   lookups lk
		JOIN   lookup_values lv
		ON     lk.lookup = lv.lookup
        ]]>
		<where>
			<if test=" _parameter != null and _parameter != '' ">
				AND lk.lookup = #{_parameter}
			</if>
		</where>
		ORDER BY lk.lookup
		,lv.lookup_code
	</select>

	<select id="getLookupValues" resultType="map">
		<![CDATA[
		SELECT l.lookup
		      ,l.lookup_description
		FROM   lookups l
		ORDER BY lookup
        ]]>
	</select>


	<select id="selectLookups" parameterType="string" resultType="map">
		SELECT *
		FROM lookup_values
		WHERE lookup = #{lookup}
	</select>

</mapper>